# CVE-2021-3560-Polkit-Privilege-Esclation PoC

## Original research by Kevin Backhouse
This is just a Bash PoC script, that automates the exploitation steps mentioned in Kevin Backhouse's blog.
Read his post on this vulnerability: https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/

## Things to note:
- This exploit works only on distributions that have installed `accountsservice` and `gnome-control-center` and it must have  `polkit` version 0.113 (or later) OR  `0-105-26` (Debian fork of `polkit`).
- This exploit was tested on `Ubuntu` `20.04`, with `polkit` version `0-105-26` (Debian fork of `polkit`). If you are sure that your target is vulnerable, but the exploit's check function fails, use the `-f=y` flag to bypass all checks and force the exploit.
- Distributions such as RHEL 8, Fedora 21, Debian testing ("bullseye") and Ubuntu 20.04 are found to be vulnerable.
- A list of distribution compatibility can be found from Kevin's [blog](https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/#history).
- This script injects a new user in sudo group. If the exploit worked, we can login to the account using `su - <username>` with the password provided to the script, and then enter `sudo bash` to drop into a root shell!
- Since this attack relies on precise timing, **MULTIPLE TRIES ARE USUALLY REQUIRED** for this exploit to work.

## How the exploit works?
- Comprehensive explanation and PoC to exploit this manually is given at the researcher's blog in detail. *TL;DR* of this exploit is given below.
- This attack requires precise timing and we have to login via SSH (or some command line session, where opening graphical applications are not an option).
- An attacker can exploit this vulnerability by triggering `polkit` by sending a `dbus` message,  but closing the request abruptly, while `polkit` is processing the request. Then the attacker can send a second request with the previoud request's unique bus identifier, to execute the request as UID `0` a.k.a `root`.
-  This vulnerability exists in `polkit`, because it treats the UID of a connection with a bus identifier that no longer exists, as a request from UID `0`. Which means that, if we can time the attack correctly and terminate our first request at the right moment, then we can request the second request with the privileges of UID `0` a.k.a `root`.
- The timing to terminate the connection is calculated as the time required to send the dbus-message / 2. Explained in detail [here](https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/#exploitation).

## Usage
```bash
USAGE:
     ./poc.sh
     -h --help
     -u=Enter custom username to insert (OPTIONAL)
     -p=Enter custom password to insert (OPTIONAL)
     -f=y, To skip vulnerability check and force exploitation. (OPTIONAL)
     -t=Enter custom sleep time, instead of automatic detection (OPTIONAL)
     Format to enter time: '-t=.004' if you want to set sleep time as 0.004ms 
Note:
Equal to symbol (=) after specifying an option is mandatory.
If you donot specify the options, then the script will automatically detect the possible time and
will try to insert a new user using that time.
Default credentials are 'secnigma:secnigmaftw'
If the exploit ran successfully, then you can login using 'su - secnigma'
and you can spawn a bash shell as root using 'sudo bash'
```
